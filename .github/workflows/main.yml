# –ò–º—è –≤–∞—à–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
name: Node.js CI/CD Pipeline

# –°–æ–±—ã—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω
on:
  push:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω –ø—Ä–∏ –ø—É—à–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É
    branches: [ main ] 
  pull_request:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É
    branches: [ main ]
  # –î–æ–±–∞–≤–ª—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á (jobs), –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
jobs:
  build_and_test:
    # –ó–∞–ø—É—Å–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ Ubuntu
    runs-on: ubuntu-latest

    # –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Node.js
    strategy:
      matrix:
        node-version: [18.x] # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Å–∏—é 18

    steps:
    - name: ‚¨áÔ∏è Checkout Code
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
        cache: 'npm' 

    - name: ‚öôÔ∏è Install Dependencies
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º npm ci –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —á—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ, —á–µ–º npm install 
      # (—Ç—Ä–µ–±—É–µ—Ç package-lock.json)
      run: npm ci

    - name: üß™ Run Tests
      # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç 'test' –∏–∑ package.json
      run: npm test

  build_and_push_docker:
    # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 'build_and_test'
    needs: build_and_test
    runs-on: ubuntu-latest
    
    # –≠—Ç–æ—Ç —à–∞–≥ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É 'main'
    if: github.ref == 'refs/heads/main' 

    steps:
    - name: ‚¨áÔ∏è Checkout Code
      uses: actions/checkout@v4
      
    - name: üîë Login to Docker Registry
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Action –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ª—é–±–æ–π Docker Registry
      uses: docker/login-action@v3
      with:
        registry: registry.gitlab.com # –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ–º GitLab Registry
        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ GitHub Secrets –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: üèóÔ∏è Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: . # –ò—â–µ–º Dockerfile –≤ –∫–æ—Ä–Ω–µ
        push: true # –†–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –æ–±—Ä–∞–∑–∞
        tags: registry.gitlab.com/your-username/ci-cd-demo:latest
